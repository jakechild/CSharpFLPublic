# This workflow will build a .NET desktop application on push or pull request events to the master branch.
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net
name: .NET Build & Publish

on:
  push:
    branches: [ "main" ]
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: write  # create releases + upload assets

jobs:

  build_test_publish:

    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        rid: [ "win-x64", "linux-x64", "osx-x64" ] # add osx-arm64 if you want

    steps:
    # Checkout the repository
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # Install the .NET Core workload
    - name: Install .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build -c Release --no-restore

    - name: Test
      run: dotnet test -c Release --no-build --verbosity normal

    #- name: Setup git
    #  run: |
    #    git config --local user.email "hello84037@gmail.com"
    #    git config --local user.name "jakechild"

    #- name: Install Versionize
    #  run: dotnet tool install --global Versionize

    #- name: Versioning
    #  id: versionize
    #  run: versionize
    #  continue-on-error: true

    # - name: Publish Windows
    #   run: dotnet publish -c Release -r win-x64 --self-contained true
    # - name: Publish Linux
    #   run: dotnet publish -c Release -r linux-x64 --self-contained true

    # Publish a self-contained, single-file executable
    - name: Publish (single-file, self-contained)
      run: |
        dotnet publish ./SBFLApp.csproj -c Release \
          -r ${{ matrix.rid }} \
          --self-contained true \
          -p:PublishSingleFile=true \
          -p:IncludeNativeLibrariesForSelfExtract=true \
          -p:EnableCompressionInSingleFile=true \
          -o publish/${{ matrix.rid }}

    # Zip per-RID output (keeps it neat for release assets)
    - name: Zip published output
      run: |
        cd publish/${{ matrix.rid }}
        zip -r ../../app-${{ matrix.rid }}.zip .
        cd -

    - name: Upload artifact (for release job)
      uses: actions/upload-artifact@v4
      with:
        name: app-${{ matrix.rid }}
        path: app-${{ matrix.rid }}.zip

    # Zip per-RID output (keeps it neat for release assets)
    - name: Zip published output
      run: |
        cd publish/${{ matrix.rid }}
        zip -r ../../app-${{ matrix.rid }}.zip .
        cd -

    - name: Upload artifact (for release job)
      uses: actions/upload-artifact@v4
      with:
        name: app-${{ matrix.rid }}
        path: app-${{ matrix.rid }}.zip

  release:
    runs-on: ubuntu-latest
    needs: build_test_publish
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub Release + upload assets
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            artifacts/**/app-*.zip

